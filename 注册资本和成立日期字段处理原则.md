# 注册资本和成立日期字段处理原则

## 概述

本文档记录了股权关系图工具中注册资本和成立日期字段的完整实现原则，包括单次导入、批量导入、子公司导入等所有场景的处理逻辑。

## 核心原则

### 1. 字段映射原则

| 文件类型 | 资本字段 | 日期字段 | 存储位置 | 显示格式 |
|---------|---------|---------|---------|---------|
| **股东文件** | `subscribed_capital_amount` (认缴出资额) | `establishment_date` (成立日期) | `top_level_entities` + `all_entities` | 认缴出资额: RMB{X}M |
| **对外投资文件** | `registration_capital` (注册资本) | `establishment_date` (成立日期) | `top_level_entities` + `all_entities` | 注册资本: RMB{X}M |
| **子公司导入** | 根据文件类型智能选择 | `establishment_date` (成立日期) | `subsidiaries` + `all_entities` | 注册资本: RMB{X}M |

### 2. 智能列检测原则

#### 2.1 股东文件检测
```python
# 认缴出资额关键词
keywords = ["认缴", "出资额", "认缴出资额"]
# 成立日期关键词  
keywords = ["成立", "注册日期", "设立", "date", "registration"]
```

#### 2.2 对外投资文件检测
```python
# 注册资本关键词
keywords = ["注册资本", "registered", "capital"]
# 成立日期关键词
keywords = ["成立", "注册日期", "设立", "date", "registration"]
```

#### 2.3 子公司导入智能选择
```python
if file_type == 'investment':
    # 对外投资文件：默认选择注册资本
    default_field = "注册资本"
else:
    # 其他文件：默认选择认缴出资额
    default_field = "认缴出资额"
```

### 3. 数据处理原则

#### 3.1 金额标准化
- **输入格式**: 支持"1000万元"、"1亿"、"5000000"等多种格式
- **标准化函数**: `normalize_amount_to_wan(amount_str)`
- **存储单位**: 统一转换为"万元"存储
- **显示格式**: 转换为"RMB{X}M"格式显示（万元÷100=百万，M=百万）

#### 3.2 日期标准化
- **输入格式**: 支持"2020-03-15"、"2020/03/15"、"2020年3月"等多种格式
- **解析函数**: `_parse_date_flexible(date_str)`
- **存储格式**: 统一存储为"YYYY-MM-DD"
- **显示格式**: 转换为"Established in {Month}.{Year}"或"Established in {Year}"

### 4. 实体存储原则

#### 4.1 单次导入存储
```python
# 股东导入
entity_data = {
    "name": entity_name,
    "type": entity_type,
    "percentage": percentage,
    "subscribed_capital_amount": subscribed_capital_amount,  # 认缴出资额
    "capital_unit": "万元",
    "establishment_date": establishment_date
}

# 子公司导入
subsidiary_data = {
    "name": subsidiary_name,
    "type": entity_type,
    "percentage": percentage,
    "registration_capital": registration_capital,  # 注册资本
    "subscribed_capital_amount": subscribed_capital_amount,  # 认缴出资额
    "capital_unit": "万元",
    "establishment_date": establishment_date
}
```

#### 4.2 批量导入存储
```python
# 根据文件类型决定字段
if file_type == 'investment':
    # 对外投资文件：处理注册资本
    entity_data["registration_capital"] = registration_capital
else:
    # 股东文件：处理认缴出资额
    entity_data["subscribed_capital_amount"] = subscribed_capital_amount
```

### 5. 数据同步原则

#### 5.1 新建实体同步
```python
# 写入到主存储
st.session_state.equity_data["top_level_entities"].append(entity_data)
# 或
st.session_state.equity_data["subsidiaries"].append(subsidiary_data)

# 同步到all_entities
if not any(e.get("name") == entity_name for e in all_entities):
    all_entity_data = {
        "name": entity_name,
        "type": entity_type,
        # 包含所有可选字段
        "registration_capital": registration_capital,
        "subscribed_capital_amount": subscribed_capital_amount,
        "capital_unit": capital_unit,
        "establishment_date": establishment_date
    }
    st.session_state.equity_data["all_entities"].append(all_entity_data)
```

#### 5.2 更新现有实体同步
```python
# 更新主存储
for i, entity in enumerate(st.session_state.equity_data["top_level_entities"]):
    if entity["name"] == entity_name:
        # 更新可选字段
        if subscribed_capital_amount is not None:
            st.session_state.equity_data["top_level_entities"][i]["subscribed_capital_amount"] = subscribed_capital_amount
        if registration_capital is not None:
            st.session_state.equity_data["top_level_entities"][i]["registration_capital"] = registration_capital
        if establishment_date:
            st.session_state.equity_data["top_level_entities"][i]["establishment_date"] = establishment_date

# 同步到all_entities
for j, ae in enumerate(st.session_state.equity_data.get("all_entities", [])):
    if ae.get("name") == entity_name:
        # 更新可选字段
        if subscribed_capital_amount is not None:
            st.session_state.equity_data["all_entities"][j]["subscribed_capital_amount"] = subscribed_capital_amount
        if registration_capital is not None:
            st.session_state.equity_data["all_entities"][j]["registration_capital"] = registration_capital
        if establishment_date:
            st.session_state.equity_data["all_entities"][j]["establishment_date"] = establishment_date
        break
```

### 6. 显示格式原则

#### 6.1 Mermaid图表显示
```python
def _format_top_entity_label(entity):
    lines = []
    
    # 第一行:英文名(如果存在)
    english_name = entity.get('english_name')
    if english_name:
        lines.append(english_name)
    
    # 第二行:中文名
    name = entity.get("name", "")
    lines.append(name)
    
    # 注册资本显示
    reg_capital_amount = entity.get('registration_capital')
    reg_capital_unit = entity.get('capital_unit')
    if reg_capital_amount is not None:
        formatted_capital = format_capital_for_display(reg_capital_amount, reg_capital_unit)
        if formatted_capital:
            lines.append(f"Registered Capital: {formatted_capital}")
    
    # 成立日期显示
    est_date_str = entity.get('establishment_date')
    if est_date_str:
        formatted_date = format_date_for_display(est_date_str)
        if formatted_date:
            lines.append(f"Established in {formatted_date}")
    
    return "\\n".join(lines)
```

#### 6.2 VisJS图表显示
```python
def _format_top_entity_label(entity):
    lines = []
    
    # 第一行:英文名(如果存在)
    english_name = entity.get("english_name")
    if english_name:
        lines.append(english_name)
    
    # 第二行:中文名
    name = entity.get("name", "")
    lines.append(name)
    
    # 第三行:注册资本
    reg_capital_amount = entity.get("registration_capital")
    reg_capital_unit = entity.get("capital_unit")
    if reg_capital_amount is not None:
        formatted_capital = format_capital_for_display(reg_capital_amount, reg_capital_unit)
        if formatted_capital:
            lines.append(f"Registered Capital: {formatted_capital}")
    
    # 第四行:成立日期
    est_date_str = entity.get("establishment_date")
    if est_date_str:
        formatted_date = format_date_for_display(est_date_str)
        if formatted_date:
            lines.append(f"Established in {formatted_date}")
    
    return "\\n".join(lines)
```

### 7. 工具函数原则

#### 7.1 金额格式化函数
```python
def normalize_amount_to_wan(amount_str):
    """将各种金额格式标准化为万元"""
    # 处理"1000万元"、"1亿"、"5000000"等格式
    # 返回float类型的万元数值

def format_capital_for_display(amount_wan, unit):
    """将万元金额格式化为显示格式"""
    # 输入: 1000.0, "万元"
    # 输出: "RMB10M" (1000万元 ÷ 100 = 10百万，M=百万)
```

#### 7.2 日期格式化函数
```python
def _parse_date_flexible(date_str):
    """灵活解析各种日期格式"""
    # 支持"2020-03-15"、"2020/03/15"、"2020年3月"等格式
    # 返回datetime.date对象

def format_date_for_display(date_str):
    """将日期格式化为显示格式"""
    # 输入: "2020-03-15"
    # 输出: "March.2020" 或 "2020"（如果只有年份）
```

### 8. 错误处理原则

#### 8.1 数据验证
```python
# 金额验证
try:
    if sc_val and sc_val.lower() not in ["nan","none","null","",""]:
        subscribed_capital_amount = normalize_amount_to_wan(sc_val)
except Exception:
    pass  # 静默处理，不中断导入流程

# 日期验证
try:
    if ed_val and ed_val.lower() not in ["nan","none","null","",""]:
        parsed_date = _parse_date_flexible(ed_val)
        if parsed_date:
            establishment_date = parsed_date.strftime("%Y-%m-%d")
except Exception:
    pass  # 静默处理，不中断导入流程
```

#### 8.2 字段完整性
- 所有可选字段都进行null检查
- 字段不存在时不写入，避免污染数据结构
- 保持向后兼容性，不影响现有功能

### 9. 性能优化原则

#### 9.1 导入优化
- 批量导入时使用智能列检测，减少用户配置
- 单次导入时提供自动默认选中，提升用户体验
- 数据处理使用异常捕获，避免单行错误影响整体导入

#### 9.2 存储优化
- 字段按需写入，避免空值污染
- 使用统一的单位存储（万元），减少转换开销
- 同步到all_entities时进行重复检查，避免重复数据

### 10. 扩展性原则

#### 10.1 新字段添加
- 遵循现有的字段命名规范
- 在UI层添加相应的列映射选项
- 在数据处理层添加解析和验证逻辑
- 在存储层确保同步到all_entities
- 在显示层添加格式化函数

#### 10.2 新文件类型支持
- 在文件类型检测函数中添加新类型
- 在列检测逻辑中添加相应的关键词
- 在数据处理逻辑中添加相应的字段处理
- 确保与现有逻辑的一致性

## 实施检查清单

### ✅ 单次导入
- [x] 股东导入：认缴出资额 + 成立日期
- [x] 子公司导入：注册资本/认缴出资额 + 成立日期（智能选择）
- [x] UI自动默认选中已识别列
- [x] 数据正确写入到实体和all_entities

### ✅ 批量导入
- [x] 股东文件：认缴出资额 + 成立日期
- [x] 对外投资文件：注册资本 + 成立日期
- [x] 智能列检测和自动处理
- [x] 数据正确写入到实体和all_entities

### ✅ 显示格式
- [x] Mermaid图表：注册资本显示为"RMB{X}M"
- [x] VisJS图表：注册资本显示为"RMB{X}M"
- [x] 成立日期显示为"Established in {Month}.{Year}"

### ✅ 工具函数
- [x] `normalize_amount_to_wan()`: 金额标准化
- [x] `format_capital_for_display()`: 金额显示格式化
- [x] `_parse_date_flexible()`: 日期解析
- [x] `format_date_for_display()`: 日期显示格式化

## 总结

本实现确保了所有导入场景下注册资本和成立日期字段的一致处理，提供了智能的列检测、自动的默认选择、标准化的数据格式和统一的显示效果。通过遵循这些原则，系统能够灵活处理各种Excel文件格式，同时保持数据的一致性和完整性。

---

*文档创建时间: 2025年1月17日*  
*最后更新: 2025年1月17日*
