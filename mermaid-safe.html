<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Mermaid é¢„è§ˆå™¨ï¼ˆæ”¯æŒç‚¹å‡»ä¿®æ”¹èŠ‚ç‚¹æ–‡å­—ï¼‰</title>
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      height: 100vh;
      overflow: hidden;
    }
    .header {
      padding: 12px 20px;
      background: #f8f9fa;
      border-bottom: 1px solid #e0e0e0;
      font-size: 16px;
      font-weight: 600;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 10px;
    }
    .controls {
      display: flex;
      gap: 8px;
      align-items: center;
    }
    .controls input {
      padding: 4px 8px;
      font-size: 14px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    .controls button {
      padding: 4px 10px;
      font-size: 14px;
      cursor: pointer;
    }
    .container {
      display: flex;
      height: calc(100vh - 80px);
      overflow: hidden;
    }
    #editor {
      height: 100%;
      min-width: 300px;
      max-width: 70%;
      display: flex;
      flex-direction: column;
    }
    #preview-container {
      flex: 1;
      min-width: 300px;
      height: 100%;
      display: flex;
      flex-direction: column;
      background: white;
      overflow: hidden;
    }
    textarea {
      flex: 1;
      padding: 14px;
      font-family: 'Consolas', monospace;
      font-size: 13px;
      line-height: 1.4;
      border: none;
      outline: none;
      resize: none;
      background: #fff;
    }
    #preview {
      flex: 1;
      padding: 20px;
      overflow: auto;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      position: relative;
    }
    #preview svg {
      min-width: 100%;
      height: auto;
      max-width: none;
      cursor: pointer;
    }
    #preview svg text {
      cursor: pointer;
      user-select: none;
    }
    #preview svg text:hover {
      fill: #1976d2 !important;
      font-weight: bold !important;
    }
    #resizer {
      width: 6px;
      background: #e0e0e0;
      cursor: col-resize;
      user-select: none;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    #resizer:hover { background: #ccc; }
    #resizer::after {
      content: "â‹®â‹®";
      color: #999;
      font-size: 14px;
      writing-mode: vertical-rl;
    }
    .error {
      padding: 10px;
      color: #d32f2f;
      background: #ffebee;
      font-family: monospace;
      white-space: pre-wrap;
    }
    .fullscreen #editor,
    .fullscreen #resizer {
      display: none;
    }
    .fullscreen .container {
      height: calc(100vh - 60px);
    }
  </style>
</head>
<body>
  <div class="header">
    ğŸ“Š Mermaid é¢„è§ˆå™¨ï¼ˆç‚¹å‡»èŠ‚ç‚¹å¯ä¿®æ”¹æ–‡å­—ï¼‰
    <div class="controls">
      <input type="text" id="keywordInput" placeholder="è¾“å…¥å…³é”®è¯é«˜äº®" value="Shanghai">
      <button id="highlightBtn">é«˜äº®</button>
      <button id="clearBtn">æ¸…é™¤é«˜äº®</button>
      <button id="fullscreenBtn">å…¨å±é¢„è§ˆ</button>
    </div>
  </div>
  <div class="container">
    <div id="editor">
      <textarea id="source" spellcheck="false"></textarea>
    </div>
    <div id="resizer"></div>
    <div id="preview-container">
      <div id="preview"></div>
    </div>
  </div>

  <script type="module">
    import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10.9.1/dist/mermaid.esm.min.mjs';

    mermaid.initialize({
      startOnLoad: false,
      theme: 'default',
      securityLevel: 'antiscript',
      flowchart: {
        useMaxWidth: false,
        htmlLabels: false,
        curve: 'cardinal'
      },
      fontFamily: '"Segoe UI", sans-serif'
    });

    const source = document.getElementById('source');
    const preview = document.getElementById('preview');
    const editor = document.getElementById('editor');
    const resizer = document.getElementById('resizer');
    const fullscreenBtn = document.getElementById('fullscreenBtn');
    const keywordInput = document.getElementById('keywordInput');
    const highlightBtn = document.getElementById('highlightBtn');
    const clearBtn = document.getElementById('clearBtn');

    let currentSvgEl = null;

    editor.style.width = '30%';
    let isFullscreen = false;

    // ========== æ¸²æŸ“å‡½æ•° ==========
    async function render() {
      const code = source.value.trim();
      preview.innerHTML = '';

      if (!code) {
        preview.textContent = 'è¯·è¾“å…¥ Mermaid ä»£ç ...';
        currentSvgEl = null;
        return;
      }

      try {
        const { svg: rawSvg } = await mermaid.render('chart', code);
        const parser = new DOMParser();
        const svgDoc = parser.parseFromString(rawSvg, 'image/svg+xml');
        currentSvgEl = svgDoc.documentElement;

        preview.innerHTML = '';
        preview.appendChild(currentSvgEl);

        currentSvgEl.style.width = '100%';
        currentSvgEl.style.height = 'auto';

        // === ç»‘å®šç‚¹å‡»äº‹ä»¶ï¼šç‚¹å‡» text ä¿®æ”¹å†…å®¹ ===
        const texts = currentSvgEl.querySelectorAll('text');
        texts.forEach(text => {
          // ç§»é™¤æ—§ç›‘å¬å™¨ï¼ˆé˜²æ­¢é‡å¤ç»‘å®šï¼‰
          text.style.cursor = 'pointer';
          const onClick = () => {
            const currentText = text.textContent || '';
            const newText = prompt('è¯·è¾“å…¥æ–°èŠ‚ç‚¹æ–‡å­—ï¼š', currentText);
            if (newText !== null && newText !== currentText) {
              text.textContent = newText;
              // å¯é€‰ï¼šè‡ªåŠ¨è°ƒæ•´æ–‡å­—ä½ç½®å±…ä¸­ï¼ˆMermaid çš„ rect é€šå¸¸æœ‰ x/y/width/heightï¼‰
              const rect = text.closest('g')?.querySelector('rect');
              if (rect) {
                const x = parseFloat(rect.getAttribute('x')) || 0;
                const width = parseFloat(rect.getAttribute('width')) || 0;
                text.setAttribute('x', x + width / 2);
                text.setAttribute('text-anchor', 'middle');
              }
            }
          };
          // å…ˆç§»é™¤å¯èƒ½çš„æ—§ç›‘å¬å™¨ï¼ˆé¿å…é‡å¤ï¼‰
          text.removeEventListener('click', onClick);
          text.addEventListener('click', onClick);
        });

      } catch (e) {
        console.error(e);
        preview.innerHTML = `<div class="error">âŒ ${e.message || e}</div>`;
        currentSvgEl = null;
      }
    }

    // ========== é«˜äº®å‡½æ•° ==========
    function highlightKeyword(keyword) {
      if (!currentSvgEl || !keyword.trim()) return;
      render(); // å…ˆé‡ç½®ï¼ˆæ¸…é™¤ä¹‹å‰é«˜äº®ï¼‰
      setTimeout(() => {
        if (!currentSvgEl) return;
        const groups = currentSvgEl.querySelectorAll('g');
        groups.forEach(g => {
          const texts = g.querySelectorAll('text');
          let match = false;
          texts.forEach(t => {
            if ((t.textContent || '').includes(keyword)) {
              match = true;
            }
          });
          if (match) {
            texts.forEach(t => {
              t.setAttribute('fill', '#d32f2f');
              t.setAttribute('font-weight', 'bold');
            });
            const rect = g.querySelector('rect');
            if (rect) {
              rect.setAttribute('fill', '#ffebee');
              rect.setAttribute('stroke', '#f44336');
              rect.setAttribute('stroke-width', '2');
            }
          }
        });
      }, 50);
    }

    function clearHighlight() {
      render();
    }

    // åˆå§‹ä»£ç 
    source.value = `graph TD
    P1["Mr. Ho Kuk Sing"] -->|11.29%| C1["IVD Holding (01931)"]
    P2["Mr. Leung King Sun"] -->|11.38%| C1
    P3["Mr. Lin Xianya"] -->|7.38%| C1
    C1 -->|100%| C2["Vastec HK"]
    C2 -->|95%| C3["Vastec Shanghai (A/R seller)"]
    C4["Shinva"] -->|27.29%| C5["Sysmex JP"]
    C5 -->|100%| C6["Sysmex Shanghai (A/R debtor)"]
    C6 -->|5%| C3
    C3 -->|70%| C7["Yunnan Vastec"]
    C3 -->|51%| C8["Beizhi Shanghai"]
    C3 -->|100%| C9["Trade & Maintenance"]
    C3 -->|51%| C10["Langmai Shandong"]

    classDef person fill:#ffebee,stroke:#f44336;
    classDef company fill:#bbdefb,stroke:#1976d2;
    class P1,P2,P3 person
    class C1,C2,C3,C4,C5,C6,C7,C8,C9,C10 company`;

    // äº‹ä»¶ç»‘å®š
    let timer;
    source.addEventListener('input', () => {
      clearTimeout(timer);
      timer = setTimeout(render, 400);
    });

    highlightBtn.addEventListener('click', () => {
      highlightKeyword(keywordInput.value);
    });

    clearBtn.addEventListener('click', () => {
      clearHighlight();
    });

    keywordInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') highlightKeyword(keywordInput.value);
    });

    // æ‹–æ‹½åˆ†å‰²æ¡
    let isResizing = false;
    resizer.addEventListener('mousedown', (e) => {
      isResizing = true;
      document.body.style.cursor = 'col-resize';
      e.preventDefault();
    });
    document.addEventListener('mousemove', (e) => {
      if (!isResizing) return;
      const containerRect = document.querySelector('.container').getBoundingClientRect();
      let leftPercent = ((e.clientX - containerRect.left) / containerRect.width) * 100;
      leftPercent = Math.max(10, Math.min(70, leftPercent));
      editor.style.width = `${leftPercent}%`;
      render();
    });
    document.addEventListener('mouseup', () => {
      isResizing = false;
      document.body.style.cursor = 'default';
    });

    // å…¨å±
    fullscreenBtn.addEventListener('click', () => {
      document.body.classList.toggle('fullscreen');
      isFullscreen = !isFullscreen;
      fullscreenBtn.textContent = isFullscreen ? 'é€€å‡ºå…¨å±' : 'å…¨å±é¢„è§ˆ';
      render();
    });

    // Ctrl + æ»šè½®ç¼©æ”¾
    let scale = 1;
    preview.addEventListener('wheel', (e) => {
      if (e.ctrlKey) {
        e.preventDefault();
        const delta = e.deltaY > 0 ? -0.1 : 0.1;
        scale = Math.max(0.5, Math.min(scale + delta, 2));
        if (currentSvgEl) {
          currentSvgEl.style.transformOrigin = '0 0';
          currentSvgEl.style.transform = `scale(${scale})`;
        }
      }
    }, { passive: false });

    // åˆå§‹æ¸²æŸ“
    render();
  </script>
</body>
</html>