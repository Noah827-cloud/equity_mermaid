                        st.session_state.equity_data["top_level_entities"].append({
                            "name": name,
                            "type": entity_type,
                            "percentage": percentage
                        })
                        
                        # æ·»åŠ åˆ°æ‰€æœ‰å®ä½“åˆ—è¡¨
                        if not any(e["name"] == name for e in st.session_state.equity_data["all_entities"]):
                            st.session_state.equity_data["all_entities"].append({
                                "name": name,
                                "type": entity_type
                            })
                        
                        st.success(f"å·²æ·»åŠ é¡¶çº§å®ä½“: {name}")
                        # ä¿®æ”¹ï¼šæ— è®ºæ˜¯å¦ç»§ç»­ï¼Œéƒ½æ·»åŠ åç«‹å³åˆ·æ–°é¡µé¢ï¼Œå®ç°å®æ—¶æ˜¾ç¤º
                        st.rerun()
                    else:
                        st.error("è¯¥å®ä½“å·²å­˜åœ¨")
                else:
                    st.error("è¯·è¾“å…¥å®ä½“åç§°")
        
        # æ–°å¢ï¼šä»Excelå¯¼å…¥è‚¡ä¸œä¿¡æ¯
        st.subheader("ğŸ“Š ä»Excelå¯¼å…¥è‚¡ä¸œä¿¡æ¯")
        st.info("ä¸Šä¼ Excelæ–‡ä»¶ï¼Œç³»ç»Ÿå°†è‡ªåŠ¨æå–åç§°å’Œå‡ºèµ„æ¯”ä¾‹ä¿¡æ¯")
        
        # æ·»åŠ æ–‡ä»¶ä¸Šä¼ å™¨
        uploaded_file = st.file_uploader("é€‰æ‹©Excelæ–‡ä»¶", type=["xlsx", "xls"])
        
        if uploaded_file is not None:
            try:
                # æ£€æŸ¥æ˜¯å¦å®‰è£…äº†pandaså’Œopenpyxl
                try:
                    import pandas as pd
                except ImportError:
                    st.error("éœ€è¦å®‰è£…pandasåº“æ¥è¯»å–Excelæ–‡ä»¶")
                    if st.button("å®‰è£…ä¾èµ–åº“"):
                            import subprocess
                            import sys
                            subprocess.check_call([sys.executable, "-m", "pip", "install", "pandas", "openpyxl"])
                            st.success("ä¾èµ–åº“å·²å®‰è£…ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•")
                            st.stop()
                
                # è¯»å–Excelæ–‡ä»¶
                # ä¿®æ”¹ï¼šå°è¯•ä¸åŒçš„æ–¹å¼è¯»å–Excelï¼Œå¤„ç†å¯èƒ½çš„ç©ºç™½è¡Œæˆ–ç‰¹æ®Šæ ¼å¼
                # é¦–å…ˆå°è¯•å¸¸è§„è¯»å–
                try:
                    df = pd.read_excel(uploaded_file)
                except Exception as e:
                    # å¦‚æœå¤±è´¥ï¼Œå°è¯•è·³è¿‡å‰å‡ è¡Œæˆ–ä½¿ç”¨å…¶ä»–é€‰é¡¹
                    st.warning(f"å¸¸è§„è¯»å–æ–¹å¼å¤±è´¥: {str(e)}")
                    st.info("å°è¯•ä½¿ç”¨å…¶ä»–æ–¹å¼è¯»å–æ–‡ä»¶...")
                    # å°è¯•è·³è¿‡å‰å‡ è¡Œ
                    df = pd.read_excel(uploaded_file, header=1)
                
                # å¦‚æœåˆ—åä»ç„¶æ˜¯Unnamedï¼Œå°è¯•é‡ç½®åˆ—å
                if any('Unnamed' in str(col) for col in df.columns):
                    # é‡ç½®åˆ—åï¼Œä½¿ç”¨æ•°å­—ç´¢å¼•
                    df.columns = [f'Column_{i}' for i in range(len(df.columns))]
                    st.info("Excelæ–‡ä»¶æ²¡æœ‰æ˜ç¡®çš„åˆ—åï¼Œå·²ä½¿ç”¨æ•°å­—ç´¢å¼•ä½œä¸ºåˆ—å")
                
                # ğŸ”¥ æ™ºèƒ½Excelåˆ†æ
                try:
                    smart_importer = create_smart_excel_importer()
                    analysis_result = smart_importer.analyze_excel_columns(df)
                    import_summary = smart_importer.get_import_summary(df, analysis_result)
                    
                    # æ˜¾ç¤ºæ™ºèƒ½åˆ†æç»“æœ
                    st.markdown("### ğŸ” æ™ºèƒ½åˆ†æç»“æœ")
                    col1, col2, col3 = st.columns(3)
                    
                    with col1:
                        st.metric("æ€»è¡Œæ•°", import_summary['total_rows'])
                    with col2:
                        st.metric("è¯†åˆ«åˆ—æ•°", import_summary['detected_columns'])
                    with col3:
                        company_count = import_summary['entity_type_distribution']['company']
                        person_count = import_summary['entity_type_distribution']['person']
                        st.metric("å…¬å¸/ä¸ªäºº", f"{company_count}/{person_count}")
                    
                    # æ˜¾ç¤ºåˆ—è¯†åˆ«ç»“æœ
                    if analysis_result['detected_columns']:
                        st.markdown("**è‡ªåŠ¨è¯†åˆ«çš„åˆ—:**")
                        for col, col_type in analysis_result['detected_columns'].items():
                            confidence = analysis_result['confidence_scores'].get(col, 0)
                            suggestion = analysis_result['column_suggestions'].get(col, '')
                            st.write(f"â€¢ {col} â†’ {suggestion} (ç½®ä¿¡åº¦: {confidence:.1%})")
                    else:
                        st.warning("âš ï¸ æœªèƒ½è‡ªåŠ¨è¯†åˆ«ä»»ä½•åˆ—ï¼Œè¯·æ‰‹åŠ¨é€‰æ‹©")
                        
                except Exception as smart_error:
                    st.error(f"æ™ºèƒ½åˆ†æå‡ºé”™: {str(smart_error)}")
                    st.info("å°†ä½¿ç”¨ä¼ ç»Ÿåˆ—é€‰æ‹©æ–¹å¼")
                    # è®¾ç½®é»˜è®¤å€¼
                    import_summary = {
                        'entity_name_column': None,
                        'investment_ratio_column': None,
                        'total_rows': len(df),
                        'detected_columns': 0,
                        'entity_type_distribution': {'company': 0, 'person': 0}
                    }
                
                # ä¿®æ”¹ï¼šç¡®ä¿æ•°æ®ç±»å‹ä¸€è‡´æ€§ï¼Œé¿å…Arrowè½¬æ¢é”™è¯¯
                # å°†æ‰€æœ‰åˆ—è½¬æ¢ä¸ºå­—ç¬¦ä¸²ç±»å‹è¿›è¡Œæ˜¾ç¤º
                df_display = df.astype(str)
                
                # æ˜¾ç¤ºå‰å‡ è¡Œæ•°æ®ä¾›ç”¨æˆ·ç¡®è®¤
                st.markdown("### ğŸ“Š æ•°æ®é¢„è§ˆ")
                st.dataframe(df_display.head(10))  # æ˜¾ç¤ºè½¬æ¢åçš„æ•°æ®
                
                # ğŸ”¥ æ™ºèƒ½åˆ—é€‰æ‹©ï¼šåŸºäºåˆ†æç»“æœè‡ªåŠ¨é€‰æ‹©
                st.markdown("### ğŸ“‹ åˆ—é€‰æ‹©")
                col1, col2 = st.columns([1, 1])
                
                with col1:
                    # æ™ºèƒ½é€‰æ‹©åç§°åˆ—
                    name_col_index = 0
                    if import_summary['entity_name_column']:
                        name_col_index = list(df.columns).index(import_summary['entity_name_column'])
                    
                    name_col_selected = st.selectbox(
                        "é€‰æ‹©åç§°åˆ—", 
                        df.columns, 
                        index=name_col_index,
                        help="è‡ªåŠ¨è¯†åˆ«ä¸ºå®ä½“åç§°åˆ—"
                    )
                    
                    # æ˜¾ç¤ºæ‰€é€‰åˆ—çš„å‰å‡ ä¸ªå€¼ä¾›å‚è€ƒ - ä½¿ç”¨å®‰å…¨è½¬æ¢
                    st.markdown("**åç§°åˆ—é¢„è§ˆ:**")
                    try:
                        name_preview = df[name_col_selected].head(5).astype(str).tolist()
                        st.write(name_preview)
                    except Exception as e:
                        st.warning(f"æ— æ³•æ˜¾ç¤ºé¢„è§ˆ: {str(e)}")
                
                with col2:
                    # æ™ºèƒ½é€‰æ‹©æ¯”ä¾‹åˆ—
                    percentage_col_index = 1 if len(df.columns) > 1 else 0
                    if import_summary['investment_ratio_column']:
                        percentage_col_index = list(df.columns).index(import_summary['investment_ratio_column'])
                    
                    percentage_col_selected = st.selectbox(
                        "é€‰æ‹©æ¯”ä¾‹åˆ—", 
                        df.columns, 
                        index=percentage_col_index,
                        help="è‡ªåŠ¨è¯†åˆ«ä¸ºæŠ•èµ„æ¯”ä¾‹åˆ—"
                    )
                    
                    # æ˜¾ç¤ºæ‰€é€‰åˆ—çš„å‰å‡ ä¸ªå€¼ä¾›å‚è€ƒ - ä½¿ç”¨å®‰å…¨è½¬æ¢
                    st.markdown("**æ¯”ä¾‹åˆ—é¢„è§ˆ:**")
                    try:
                        percent_preview = df[percentage_col_selected].head(5).astype(str).tolist()
                        st.write(percent_preview)
                    except Exception as e:
                        st.warning(f"æ— æ³•æ˜¾ç¤ºé¢„è§ˆ: {str(e)}")

                # é€‰æ‹©ç™»è®°çŠ¶æ€åˆ—ï¼ˆå¯é€‰ï¼‰
                try:
                    status_auto_top = _find_status_column(df, analysis_result)
                except Exception:
                    status_auto_top = None
                status_options_top = ["ï¼ˆä¸ä½¿ç”¨ï¼‰"] + list(df.columns)
                default_status_idx_top = 0
                if status_auto_top and status_auto_top in df.columns:
                    default_status_idx_top = 1 + list(df.columns).index(status_auto_top)
                status_choice_top = st.selectbox(
                    "é€‰æ‹©ç™»è®°çŠ¶æ€åˆ—ï¼ˆå¯é€‰ï¼‰",
                    status_options_top,
                    index=default_status_idx_top,
                    help="è‹¥ä¸ºæ³¨é”€/åŠé”€å°†è·³è¿‡å¯¼å…¥",
                    key="status_col_selected_top_ui",
                )
                st.session_state["status_col_selected_top"] = None if status_choice_top == "ï¼ˆä¸ä½¿ç”¨ï¼‰" else status_choice_top

                # æ·»åŠ ä¸€ä¸ªé€‰é¡¹æ¥è·³è¿‡æŸäº›è¡Œï¼ˆå¦‚æ ‡é¢˜è¡Œï¼‰
                skip_rows = st.number_input("è·³è¿‡å‰å‡ è¡Œï¼ˆå¦‚æœæ•°æ®ä¸Šæ–¹æœ‰æ ‡é¢˜æˆ–è¯´æ˜ï¼‰", min_value=0, max_value=10, value=0)
                
                # ğŸ”¥ æ™ºèƒ½å®ä½“ç±»å‹é€‰æ‹©
                st.markdown("### ğŸ¢ å®ä½“ç±»å‹è®¾ç½®")
                auto_detect_type = st.checkbox("å¯ç”¨è‡ªåŠ¨ç±»å‹åˆ¤æ–­", value=True, help="æ ¹æ®åç§°è‡ªåŠ¨åˆ¤æ–­æ˜¯å…¬å¸è¿˜æ˜¯ä¸ªäºº")
                
                if auto_detect_type:
                    st.info("âœ… å°†æ ¹æ®åç§°è‡ªåŠ¨åˆ¤æ–­å®ä½“ç±»å‹ï¼šå…¬å¸åç§°åŒ…å«'æœ‰é™å…¬å¸'ç­‰å…³é”®è¯ï¼Œä¸ªäººå§“åé€šå¸¸2-4ä¸ªä¸­æ–‡å­—ç¬¦")
                    default_entity_type = "company"  # é»˜è®¤å€¼ï¼Œå®é™…ä¼šæ ¹æ®åç§°åˆ¤æ–­
                else:
                    default_entity_type = st.selectbox("é»˜è®¤å®ä½“ç±»å‹", ["company", "person"], help="å¯¼å…¥çš„å®ä½“é»˜è®¤ç±»å‹")
                
                # å¯¼å…¥æŒ‰é’®
                if st.button("å¼€å§‹å¯¼å…¥", type="primary"):
                    # æ·»åŠ å¯¼å…¥è¿‡ç¨‹çš„æ—¥å¿—ï¼ˆå†…éƒ¨æ—¥å¿—ï¼Œä¸å…¨éƒ¨æ˜¾ç¤ºåœ¨ç•Œé¢ï¼‰
                    import logging
                    logging.basicConfig(level=logging.INFO)
                    logger = logging.getLogger("excel_import")
                    
                    # æ˜¾ç¤ºæ­£åœ¨å¤„ç†çš„ä¿¡æ¯
                    processing_placeholder = st.info("æ­£åœ¨å¤„ç†å¯¼å…¥...")
                    
                    # ä¿å­˜åŸå§‹åˆ—ç´¢å¼•è€Œä¸æ˜¯åˆ—å
                    name_col_index = list(df.columns).index(name_col_selected)
                    percentage_col_index = list(df.columns).index(percentage_col_selected)
                    
                    # é‡æ–°è¯»å–å¹¶è·³è¿‡æŒ‡å®šçš„è¡Œæ•°
                    df_processing = None
                    try:
                        if skip_rows > 0:
                            df_processing = pd.read_excel(uploaded_file, skiprows=skip_rows)
                            # å†æ¬¡å¤„ç†åˆ—å
                            if any('Unnamed' in str(col) for col in df_processing.columns):
                                df_processing.columns = [f'Column_{i}' for i in range(len(df_processing.columns))]
                        else:
                            # å¦‚æœä¸è·³è¿‡è¡Œï¼Œç›´æ¥ä½¿ç”¨åŸå§‹æ•°æ®
                            df_processing = df.copy()
                    except Exception as e:
                        processing_placeholder.empty()
                        st.error(f"è¯»å–æ•°æ®å¤±è´¥: {str(e)}")
                        st.stop()
                    
                    # ç¡®ä¿ç´¢å¼•æœ‰æ•ˆ
                    if name_col_index >= len(df_processing.columns) or percentage_col_index >= len(df_processing.columns):
                        processing_placeholder.empty()
                        st.error("é€‰æ‹©çš„åˆ—ç´¢å¼•è¶…å‡ºæ•°æ®èŒƒå›´ï¼")
                        st.stop()
                    
                    # æ ¹æ®ç´¢å¼•è·å–å®é™…çš„åˆ—å
                    actual_name_col = df_processing.columns[name_col_index]
                    actual_percentage_col = df_processing.columns[percentage_col_index]
                    
                    imported_count = 0
                    skipped_count = 0
                    errors = []

                    # è¯†åˆ«â€œç™»è®°çŠ¶æ€â€åˆ—ï¼ˆé¡¶å±‚å®ä½“å¯¼å…¥ï¼‰
                    try:
                        status_col_main = st.session_state.get("status_col_selected_top") or _find_status_column(df_processing, analysis_result)
                    except Exception:
                        status_col_main = st.session_state.get("status_col_selected_top")
                    
                    # å¤„ç†æ¯ä¸€è¡Œæ•°æ®
                    for index, row in df_processing.iterrows():
                        try:
                            # è·å–åç§°å’Œæ¯”ä¾‹ - å®‰å…¨è½¬æ¢ä¸ºå­—ç¬¦ä¸²
                            try:
                                entity_name = str(row[actual_name_col]).strip()
                            except Exception as e:
                                raise ValueError(f"è·å–åç§°å¤±è´¥: {str(e)}")
                            
                            try:
                                percentage_value = row[actual_percentage_col]
                            except Exception as e:
                                raise ValueError(f"è·å–æ¯”ä¾‹å¤±è´¥: {str(e)}")
                            
                            logger.info(f"å¤„ç†è¡Œ {index+1}: åç§°='{entity_name}', æ¯”ä¾‹å€¼='{percentage_value}'")

                            # è‹¥ç™»è®°çŠ¶æ€ä¸ºæ³¨é”€/åŠé”€ï¼Œåˆ™è·³è¿‡
                            try:
                                status_value = row[status_col_main] if status_col_main and status_col_main in df_processing.columns else None
                            except Exception:
                                status_value = None
                            if _is_inactive_status(status_value):
                                skipped_count += 1
                                errors.append(f"ç¬¬{index+1}è¡Œ: ç™»è®°çŠ¶æ€ä¸ºâ€œ{status_value}â€ï¼Œå·²è·³è¿‡")
                                continue
                            
                            # è·³è¿‡ç©ºåç§°æˆ–æ— æ•ˆåç§°
                            if not entity_name or entity_name.lower() in ["nan", "none", "null", "", "-"]:
                                skipped_count += 1
                                continue
                            
                            # å°è¯•å°†æ¯”ä¾‹è½¬æ¢ä¸ºæ•°å­—
                            percentage = None
                            try:
                                percentage = float(percentage_value)
                                # ç¡®ä¿æ¯”ä¾‹åœ¨æœ‰æ•ˆèŒƒå›´å†…
                                if percentage < 0 or percentage > 100:
                                    skipped_count += 1
                                    errors.append(f"ç¬¬{index+1}è¡Œ: æ¯”ä¾‹ {percentage} è¶…å‡ºæœ‰æ•ˆèŒƒå›´")
                                    continue
                            except (ValueError, TypeError):
                                # å°è¯•ä»å­—ç¬¦ä¸²ä¸­æå–æ•°å­—ï¼ˆå¤„ç†å¦‚"30%"è¿™æ ·çš„å€¼ï¼‰
                                try:
                                    import re
                                    # å°è¯•ä»å­—ç¬¦ä¸²ä¸­æå–æ•°å­—
                                    num_str = re.search(r'\d+(\.\d+)?', str(percentage_value))
                                    if num_str:
                                        percentage = float(num_str.group())
                                        if not (0 <= percentage <= 100):
                                            skipped_count += 1
                                            errors.append(f"ç¬¬{index+1}è¡Œ: æå–çš„æ¯”ä¾‹ {percentage} è¶…å‡ºæœ‰æ•ˆèŒƒå›´")
                                            continue
                                    else:
                                        skipped_count += 1
                                        errors.append(f"ç¬¬{index+1}è¡Œ: æ— æ³•ä» '{percentage_value}' ä¸­æå–æ¯”ä¾‹")
                                        continue
                                except Exception as e:
                                    # å¦‚æœæ— æ³•è½¬æ¢ä¸ºæ•°å­—ï¼Œè·³è¿‡
                                    skipped_count += 1
                                    errors.append(f"ç¬¬{index+1}è¡Œ: æ¯”ä¾‹è½¬æ¢å¤±è´¥ - {str(e)}")
                                    continue
                            
                            # æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
                            exists = False
                            for i, entity in enumerate(st.session_state.equity_data["top_level_entities"]):
                                if entity["name"] == entity_name:
                                    # æ›´æ–°ç°æœ‰å®ä½“çš„ç™¾åˆ†æ¯”
                                    st.session_state.equity_data["top_level_entities"][i]["percentage"] = percentage
                                    exists = True
                                    imported_count += 1
                                    logger.info(f"ç¬¬{index+1}è¡Œ: æ›´æ–°ç°æœ‰å®ä½“ '{entity_name}' çš„æ¯”ä¾‹ä¸º {percentage}%")
                                    break
                            
                            # å¦‚æœä¸å­˜åœ¨ï¼Œæ·»åŠ æ–°å®ä½“
                            if not exists:
                                # ğŸ”¥ æ™ºèƒ½ç±»å‹åˆ¤æ–­
                                if auto_detect_type:
                                    entity_type = smart_importer.auto_detect_entity_type(entity_name)
                                else:
                                    entity_type = default_entity_type
                                
                                st.session_state.equity_data["top_level_entities"].append({
                                    "name": entity_name,
                                    "type": entity_type,
                                    "percentage": percentage
                                })
                                
                                # æ·»åŠ åˆ°æ‰€æœ‰å®ä½“åˆ—è¡¨
                                if not any(e["name"] == entity_name for e in st.session_state.equity_data["all_entities"]):
                                    st.session_state.equity_data["all_entities"].append({
                                        "name": entity_name,
                                        "type": entity_type
                                    })
                                
                                imported_count += 1
                                logger.info(f"ç¬¬{index+1}è¡Œ: æ–°å¢å®ä½“ '{entity_name}' æ¯”ä¾‹ä¸º {percentage}%")
                        except Exception as e:
                            skipped_count += 1
                            error_msg = f"ç¬¬{index+1}è¡Œ: å¤„ç†å¤±è´¥ - {str(e)}"
                            errors.append(error_msg)
                            logger.error(error_msg)
                    
                    # æ›´æ–°å ä½ç¬¦ä¸ºå¤„ç†å®Œæˆ
                    processing_placeholder.empty()
                    
                    # æ˜¾ç¤ºå¯¼å…¥ç»“æœï¼Œä½¿ç”¨æ›´é†’ç›®çš„æ ¼å¼
                    st.markdown("### å¯¼å…¥ç»“æœ")
                    col1, col2 = st.columns(2)
                    with col1:
                        st.metric("æˆåŠŸå¯¼å…¥", imported_count)
                    with col2:
                        st.metric("è·³è¿‡è®°å½•", skipped_count)
                    
                    # å¦‚æœæœ‰é”™è¯¯ï¼Œæ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
                    if errors:
                        st.warning(f"å…± {len(errors)} æ¡è®°å½•å¤„ç†å¤±è´¥:")
                        # ä½¿ç”¨expanderæŠ˜å é”™è¯¯ä¿¡æ¯ï¼Œé¿å…å ç”¨å¤ªå¤šç©ºé—´
                        with st.expander("æŸ¥çœ‹è¯¦ç»†é”™è¯¯ä¿¡æ¯"):
                            for error in errors:
                                st.code(error)
                    
                    # æ·»åŠ ä¸€ä¸ªç¡®è®¤æŒ‰é’®å†åˆ·æ–°ï¼Œè®©ç”¨æˆ·æœ‰æ—¶é—´æŸ¥çœ‹ç»“æœ
                    if st.button("ç¡®è®¤å¹¶åˆ·æ–°åˆ—è¡¨", type="primary", key="main_import_refresh"):
                        st.rerun()
                    else:
