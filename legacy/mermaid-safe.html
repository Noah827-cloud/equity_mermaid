<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Mermaid é¢„è§ˆå™¨ï¼ˆåŒå‡»åŒæ­¥ä¿®æ”¹ä»£ç ï½œå¢å¼ºç‰ˆï¼‰</title>
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      height: 100vh;
      overflow: hidden;
    }
    .header {
      padding: 12px 20px;
      background: #f8f9fa;
      border-bottom: 1px solid #e0e0e0;
      font-size: 16px;
      font-weight: 600;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 10px;
    }
    .controls {
      display: flex;
      gap: 8px;
      align-items: center;
    }
    .controls input {
      padding: 4px 8px;
      font-size: 14px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    .controls button {
      padding: 4px 10px;
      font-size: 14px;
      cursor: pointer;
    }
    .container {
      display: flex;
      height: calc(100vh - 80px);
      overflow: hidden;
    }
    #editor {
      height: 100%;
      min-width: 300px;
      max-width: 70%;
      display: flex;
      flex-direction: column;
    }
    #preview-container {
      flex: 1;
      min-width: 300px;
      height: 100%;
      display: flex;
      flex-direction: column;
      background: white;
      overflow: hidden;
    }
    textarea {
      flex: 1;
      padding: 14px;
      font-family: 'Consolas', monospace;
      font-size: 13px;
      line-height: 1.4;
      border: none;
      outline: none;
      resize: none;
      background: #fff;
    }
    #preview {
      flex: 1;
      padding: 20px;
      overflow: hidden;
      display: flex;
      justify-content: flex-start;
      align-items: flex-start;
      position: relative;
      cursor: default;
    }
    #preview svg {
      min-width: 100%;
      height: auto;
      max-width: none;
      cursor: pointer;
    }
    #preview svg text {
      cursor: pointer;
      user-select: none;
    }
    #preview svg text:hover {
      fill: #1976d2 !important;
      font-weight: bold !important;
    }

    /* æ‹–æ‹½æ—¶çš„å…‰æ ‡æ ·å¼ */
    #preview.dragging {
      cursor: grab;
    }
    #preview.dragging svg {
      cursor: grabbing !important;
    }

    #resizer {
      width: 6px;
      background: #e0e0e0;
      cursor: col-resize;
      user-select: none;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    #resizer:hover { background: #ccc; }
    #resizer::after {
      content: "â‹®â‹®";
      color: #999;
      font-size: 14px;
      writing-mode: vertical-rl;
    }
    .error {
      padding: 10px;
      color: #d32f2f;
      background: #ffebee;
      font-family: monospace;
      white-space: pre-wrap;
    }
    .fullscreen #editor,
    .fullscreen #resizer {
      display: none;
    }
    .fullscreen .container {
      height: calc(100vh - 60px);
    }
  </style>
</head>
<body>
  <div class="header">
    ğŸ“Š Mermaid é¢„è§ˆå™¨ï¼ˆåŒå‡»èŠ‚ç‚¹åŒæ­¥ä¿®æ”¹ä»£ç ï½œå¢å¼ºå…¼å®¹æ€§ï¼‰
    <div class="controls">
      <input type="text" id="keywordInput" placeholder="è¾“å…¥å…³é”®è¯é«˜äº®" value="Shanghai">
      <button id="highlightBtn">é«˜äº®</button>
      <button id="clearBtn">æ¸…é™¤é«˜äº®</button>
      <button id="fullscreenBtn">å…¨å±é¢„è§ˆ</button>
    </div>
  </div>
  <div class="container">
    <div id="editor">
      <textarea id="source" spellcheck="false"></textarea>
    </div>
    <div id="resizer"></div>
    <div id="preview-container">
      <div id="preview"></div>
    </div>
  </div>

  <script type="module">
    import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10.9.1/dist/mermaid.esm.min.mjs';

    mermaid.initialize({
      startOnLoad: false,
      theme: 'default',
      securityLevel: 'antiscript',
      flowchart: {
        useMaxWidth: false,
        htmlLabels: false,
        curve: 'linear'
      },
      fontFamily: '"Segoe UI", sans-serif'
    });

    const source = document.getElementById('source');
    const preview = document.getElementById('preview');
    const editor = document.getElementById('editor');
    const resizer = document.getElementById('resizer');
    const fullscreenBtn = document.getElementById('fullscreenBtn');
    const keywordInput = document.getElementById('keywordInput');
    const highlightBtn = document.getElementById('highlightBtn');
    const clearBtn = document.getElementById('clearBtn');

    let currentSvgEl = null;
    let isFullscreen = false;
    let scale = 1;
    let translateX = 0;
    let translateY = 0;

    editor.style.width = '30%';

    // ========== å·¥å…·å‡½æ•° ==========
    function escapeRegExp(string) {
      return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    }

    // âœ… ä¿®å¤ç‰ˆï¼šé€šè¿‡æ˜¾ç¤ºæ–‡æœ¬ç²¾å‡†åŒ¹é… Mermaid èŠ‚ç‚¹å®šä¹‰ï¼ˆæ”¯æŒ ["xxx"]ã€('xxx')ã€{xxx} ç­‰ï¼‰
    function updateMermaidCodeByText(oldText, newText) {
      const code = source.value;
      const lines = code.split('\n');
      const escapedOld = escapeRegExp(oldText);

      for (let i = 0; i < lines.length; i++) {
        let line = lines[i];
        // åŒ¹é… ID["æ–‡æœ¬"]ã€ID('æ–‡æœ¬')ã€ID{æ–‡æœ¬} ç­‰æ ¼å¼ï¼ˆå…è®¸ç©ºæ ¼ï¼‰
        const match = line.match(/([\w\u4e00-\u9fa5\-\.]+)\s*([
$$
({])\s*["']([^"']*)["']\s*([
$$
)}])/);
        if (match && match[3] === oldText) {
          const id = match[1];
          const open = match[2];   // e.g. '['
          const close = match[4];  // e.g. ']'

          // âœ… å…³é”®ä¿®å¤ï¼šå¯¹ open å’Œ close ä¹Ÿè¿›è¡Œè½¬ä¹‰ï¼
          const escapedId = escapeRegExp(id);
          const escapedOpen = escapeRegExp(open);
          const escapedClose = escapeRegExp(close);

          const pattern = `${escapedId}\\s*${escapedOpen}\\s*["']${escapedOld}["']\\s*${escapedClose}`;
          const re = new RegExp(pattern);

          if (re.test(line)) {
            // æ„é€ æ›¿æ¢å†…å®¹ï¼šä¿ç•™åŸå§‹æ‹¬å·ç±»å‹ï¼Œä½†ç»Ÿä¸€ç”¨åŒå¼•å·åŒ…è£¹æ–‡æœ¬
            const replacement = `${id}${open}"${newText}"${close}`;
            lines[i] = line.replace(re, replacement);
            source.value = lines.join('\n');
            render();
            return true;
          }
        }
      }
      return false;
    }

    // ========== æ¸²æŸ“å‡½æ•° ==========
    async function render() {
      const code = source.value.trim();
      preview.innerHTML = '';

      if (!code) {
        preview.textContent = 'è¯·è¾“å…¥ Mermaid ä»£ç ...';
        currentSvgEl = null;
        return;
      }

      try {
        const { svg: rawSvg } = await mermaid.render('chart', code);
        const parser = new DOMParser();
        const svgDoc = parser.parseFromString(rawSvg, 'image/svg+xml');
        currentSvgEl = svgDoc.documentElement;

        preview.innerHTML = '';
        preview.appendChild(currentSvgEl);

        applyTransform();

        // === ç»‘å®šåŒå‡»äº‹ä»¶ ===
        const texts = currentSvgEl.querySelectorAll('text');
        texts.forEach(text => {
          text.style.cursor = 'pointer';
          const originalText = text.textContent || '';
          text.setAttribute('data-original-text', originalText);

          const onDblClick = () => {
            const oldText = text.getAttribute('data-original-text') || text.textContent;
            const newText = prompt('è¯·è¾“å…¥æ–°èŠ‚ç‚¹æ–‡å­—ï¼š', oldText);
            if (newText === null || newText === oldText) return;

            // æ›´æ–° SVG æ˜¾ç¤º
            text.textContent = newText;
            text.setAttribute('data-original-text', newText);
            const rect = text.closest('g')?.querySelector('rect');
            if (rect) {
              const x = parseFloat(rect.getAttribute('x')) || 0;
              const width = parseFloat(rect.getAttribute('width')) || 0;
              text.setAttribute('x', x + width / 2);
              text.setAttribute('text-anchor', 'middle');
            }

            // âœ… ä»…é€šè¿‡æ–‡æœ¬æ›´æ–°æºç ï¼ˆä¸å†ä¾èµ– nodeIdï¼‰
            const updated = updateMermaidCodeByText(oldText, newText);
            if (!updated) {
              alert('æœªèƒ½è‡ªåŠ¨æ›´æ–°ä»£ç ï¼Œè¯·æ‰‹åŠ¨ä¿®æ”¹å·¦ä¾§ Mermaid å†…å®¹ã€‚');
            }
          };

          // é˜²æ­¢é‡å¤ç»‘å®š
          text.removeEventListener('dblclick', onDblClick);
          text.addEventListener('dblclick', onDblClick);
        });

      } catch (e) {
        console.error(e);
        preview.innerHTML = `<div class="error">âŒ ${e.message || e}</div>`;
        currentSvgEl = null;
      }
    }

    function applyTransform() {
      if (currentSvgEl) {
        currentSvgEl.style.transformOrigin = '0 0';
        currentSvgEl.style.transform = `scale(${scale}) translate(${translateX}px, ${translateY}px)`;
      }
    }

    // ========== é«˜äº®å‡½æ•° ==========
    function highlightKeyword(keyword) {
      if (!currentSvgEl || !keyword.trim()) return;
      render();
      setTimeout(() => {
        if (!currentSvgEl) return;
        const groups = currentSvgEl.querySelectorAll('g');
        groups.forEach(g => {
          const texts = g.querySelectorAll('text');
          let match = false;
          texts.forEach(t => {
            if ((t.textContent || '').includes(keyword)) {
              match = true;
            }
          });
          if (match) {
            texts.forEach(t => {
              t.setAttribute('fill', '#d32f2f');
              t.setAttribute('font-weight', 'bold');
            });
            const rect = g.querySelector('rect');
            if (rect) {
              rect.setAttribute('fill', '#ffebee');
              rect.setAttribute('stroke', '#f44336');
              rect.setAttribute('stroke-width', '2');
            }
          }
        });
      }, 50);
    }

    function clearHighlight() {
      render();
    }

    // åˆå§‹ä»£ç 
    source.value = `flowchart TD
    A["ç”°æ¡‘"] -->|51.3287%| B["æ¡‘æœå¥åº·ç§‘æŠ€å‘å±•ï¼ˆä¸Šæµ·ï¼‰æœ‰é™å…¬å¸"]
    SH1["ä¸Šæµ·æ¡‘æ¯”ç§‘æŠ€åˆä¼™ä¼ä¸šï¼ˆæœ‰é™åˆä¼™ï¼‰"] -->|22.6713%| B
    SH2["ä¸Šæµ·é¸¿ä¿ä¿¡æ¯æŠ€æœ¯ä¸­å¿ƒï¼ˆæœ‰é™åˆä¼™ï¼‰"] -->|20.0000%| B
    SH3["ä¸Šæµ·æ—¶æ¡‘ç§‘æŠ€åˆä¼™ä¼ä¸šï¼ˆæœ‰é™åˆä¼™ï¼‰"] -->|6.0000%| B
    B -->|100%| SUB1["æ¡‘æœï¼ˆä¸Šæµ·ï¼‰ä¿¡æ¯æŠ€æœ¯æœ‰é™å…¬å¸"]
    B -->|100%| SUB2["æˆéƒ½åŒæµæ¡‘æœäº’è”ç½‘åŒ»é™¢æœ‰é™å…¬å¸"]
    B -->|70%| SUB3["æ¡‘æœå¥åº·ç§‘æŠ€å‘å±•ï¼ˆæ— é”¡ï¼‰æœ‰é™å…¬å¸"]
    B -->|60%| SUB4["æµ·å—æ¡‘æœå¥åº·ç§‘æŠ€æœ‰é™å…¬å¸"]
    B -->|5%| SUB5["ä¸Šæµ·æŸé’å¥åº·ç§‘æŠ€æœ‰é™å…¬å¸"]

    classDef person fill:#ffebee,stroke:#f44336;
    classDef company fill:#bbdefb,stroke:#1976d2;
    classDef sub fill:#e0f7fa,stroke:#00bcd4;
    class A person
    class B company
    class SUB1,SUB2,SUB3,SUB4,SUB5 sub`;

    // ========== æ‹–æ‹½å¹³ç§»é€»è¾‘ ==========
    let isDragging = false;
    let startX, startY, startTranslateX, startTranslateY;

    preview.addEventListener('mousedown', (e) => {
      if (!is