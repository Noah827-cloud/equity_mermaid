# 文件名格式灵活解析功能

**更新日期**: 2025-10-24  
**功能**: 智能识别批量导入文件的公司名和关系类型，无论顺序如何

## 📋 问题背景

### 旧格式（之前支持）
```
山东蓝电电力有限公司-股东信息.xlsx
力诺集团股份有限公司-对外投资.xlsx
```
格式：`公司名-关系类型`

### 新格式（现在也支持）
```
股东信息工商登记-山东蓝电电力有限公司.xlsx
对外投资-力诺集团股份有限公司.xlsx
```
格式：`关系类型-公司名`

### 用户需求
> "无论是正是反都能正确识别，先把-前后的内容都识别好，然后再判断哪一个是公司名，哪一个是关系，而不是统一规则，前面是公司后面是关系"

---

## ✨ 解决方案

### 智能识别逻辑

#### 步骤 1: 预处理
```
输入: "2_股东信息工商登记-山东蓝电电力有限公司-20251024.xlsx"

处理:
1. 移除扩展名        → "2_股东信息工商登记-山东蓝电电力有限公司-20251024"
2. 移除序号前缀      → "股东信息工商登记-山东蓝电电力有限公司-20251024"
3. 移除时间戳后缀    → "股东信息工商登记-山东蓝电电力有限公司"
```

#### 步骤 2: 按分隔符拆分
```
拆分: "股东信息工商登记-山东蓝电电力有限公司"
      ↓
parts = ["股东信息工商登记", "山东蓝电电力有限公司"]
```

#### 步骤 3: 智能分类
```python
for part in parts:
    # 判断是否包含关系类型关键词
    if "股东" in part or "对外投资" in part or "控制企业" in part:
        → 归类为关系类型
    
    # 判断是否包含公司关键词
    elif "有限公司" in part or "集团" in part or "公司" in part:
        → 归类为公司名
```

**结果**:
- 关系类型部分: `["股东信息工商登记"]`
- 公司名部分: `["山东蓝电电力有限公司"]`

#### 步骤 4: 选择最佳公司名
```
优先选择包含明确公司关键词的部分:
"山东蓝电电力有限公司" ✅ (包含"有限公司")
```

---

## 🎯 支持的文件名格式

### ✅ 旧格式（公司名在前）
| 文件名 | 提取的公司名 | 关系类型 |
|--------|------------|----------|
| `山东蓝电电力有限公司-股东信息.xlsx` | 山东蓝电电力有限公司 | 股东 |
| `力诺集团-对外投资.xlsx` | 力诺集团 | 对外投资 |
| `2_常州蓝托公司-控制企业-20251024.xlsx` | 常州蓝托公司 | 控制企业 |

### ✅ 新格式（关系类型在前）
| 文件名 | 提取的公司名 | 关系类型 |
|--------|------------|----------|
| `股东信息工商登记-山东蓝电电力有限公司.xlsx` | 山东蓝电电力有限公司 | 股东 |
| `对外投资-力诺集团股份有限公司.xlsx` | 力诺集团股份有限公司 | 对外投资 |
| `控制企业-某某有限公司.xlsx` | 某某有限公司 | 控制企业 |

### ✅ 复杂格式（混合）
| 文件名 | 提取的公司名 | 关系类型 |
|--------|------------|----------|
| `5_股东信息-ABC集团有限公司-对外投资.xlsx` | ABC集团有限公司 | 股东 |
| `工商登记股东-测试企业-20251024.xlsx` | 测试企业 | 股东 |

---

## 🔍 关键词列表

### 公司关键词
用于识别哪部分是公司名：
```python
company_keywords = [
    # 中文公司类型
    '有限公司', '有限责任公司', '股份有限公司', '股份公司',
    '集团', '有限合伙', '合伙企业', '普通合伙',
    
    # 英文公司类型
    'Co.', 'Ltd.', 'Corp.', 'Inc.', 'Limited', 'Corporation',
    
    # 通用词
    '公司', '企业', '中心', '研究院', '基金'
]
```

### 关系类型关键词
用于识别哪部分是关系类型：
```python
relationship_keywords = [
    # 股东相关
    '股东信息', '股东明细', '股东名单', '股东', 
    '发起人', '投资人', '投资方',
    
    # 对外投资相关
    '对外投资', '被投资', '控制企业', '子公司', 
    '被投资企业', '投资',
    
    # 工商登记
    '工商登记', '登记信息', '基本信息',
    
    # 英文
    'shareholder', 'investor', 'investment', 'subsidiary'
]
```

---

## 💡 智能识别规则

### 规则 1: 明确的公司关键词优先
```
文件名: "股东信息-山东蓝电电力有限公司"
判断:
  - "股东信息" → 包含"股东" (关系类型关键词)
  - "山东蓝电电力有限公司" → 包含"有限公司" (公司关键词) ✅
选择: "山东蓝电电力有限公司"
```

### 规则 2: 排除纯关系类型
```
文件名: "工商登记-ABC公司-股东"
判断:
  - "工商登记" → 纯关系类型，排除
  - "ABC公司" → 包含"公司" ✅
  - "股东" → 纯关系类型，排除
选择: "ABC公司"
```

### 规则 3: 同时包含时优先公司关键词
```
文件名: "某某投资公司-对外投资"
判断:
  - "某某投资公司" → 包含"公司" (公司关键词) + "投资" (关系类型关键词)
  - "对外投资" → 纯关系类型
结论: 虽然包含"投资"，但有"公司"更重要 ✅
选择: "某某投资公司"
```

### 规则 4: 清理前后缀
```
输入: "股东信息ABC公司"
清理:
  - 发现开头包含"股东信息" → 移除 → "ABC公司" ✅

输入: "某某集团对外投资"
清理:
  - 发现结尾包含"对外投资" → 移除 → "某某集团" ✅
```

---

## 🧪 测试用例

### 测试场景 1: 旧格式
```python
输入: "山东蓝电电力有限公司-股东信息.xlsx"
预期: "山东蓝电电力有限公司"
结果: ✅ 通过
```

### 测试场景 2: 新格式
```python
输入: "股东信息工商登记-山东蓝电电力有限公司.xlsx"
预期: "山东蓝电电力有限公司"
结果: ✅ 通过
```

### 测试场景 3: 带序号和时间戳
```python
输入: "2_对外投资-力诺集团-20251024165432.xlsx"
预期: "力诺集团"
结果: ✅ 通过
```

### 测试场景 4: 多个分隔符
```python
输入: "工商登记_股东信息-ABC集团有限公司.xlsx"
预期: "ABC集团有限公司"
结果: ✅ 通过
```

### 测试场景 5: 边界情况
```python
输入: "某某投资有限公司-对外投资.xlsx"
预期: "某某投资有限公司"
说明: 虽然公司名包含"投资"，但有"有限公司"更明确
结果: ✅ 通过
```

---

## 🔧 技术实现

### 核心函数
```python
def _extract_company_name_from_filename(filename: str) -> str:
    """智能提取公司名称"""
    # 1. 预处理（移除扩展名、序号、时间戳）
    # 2. 按分隔符拆分
    # 3. 分类：公司名 vs 关系类型
    # 4. 选择最佳公司名
    # 5. 清理前后缀
```

### 代码位置
`src/main/manual_equity_editor.py` - 第 133-259 行

---

## ✅ 优势

### 1. **无需用户关心顺序**
- ✅ 公司名在前或在后都能识别
- ✅ 自动适应不同的命名习惯

### 2. **智能容错**
- ✅ 即使包含混淆词汇也能正确判断
- ✅ 多种分隔符都支持

### 3. **向后兼容**
- ✅ 旧格式继续正常工作
- ✅ 不影响现有用户

### 4. **可扩展**
- ✅ 轻松添加新的关键词
- ✅ 支持自定义规则

---

## 📝 使用建议

### 推荐的文件命名规范

#### 方式 1: 明确的公司后缀（推荐）
```
✅ 股东信息-山东蓝电电力有限公司.xlsx
✅ 对外投资-力诺集团股份有限公司.xlsx
```

#### 方式 2: 传统格式（也支持）
```
✅ 山东蓝电电力有限公司-股东信息.xlsx
✅ 力诺集团股份有限公司-对外投资.xlsx
```

#### 避免的命名方式
```
❌ 股东-投资.xlsx  (两个都是关键词，无法区分)
❌ 股东信息-对外投资.xlsx  (两个都是关系类型)
❌ ABC-DEF.xlsx  (完全没有关键词)
```

### 最佳实践
1. **确保公司名包含公司类型**（如"有限公司"、"集团"等）
2. **关系类型使用标准词汇**（如"股东信息"、"对外投资"）
3. **避免混淆**（不要让公司名和关系类型都包含"投资"等模糊词）

---

## 🆕 更新记录

- **2025-10-24**: 实现智能识别功能，支持双向格式
- **2025-10-24**: 添加"工商登记"等新关键词
- **2025-10-24**: 优化清理逻辑，处理前后缀

---

## 📚 相关文档

- `FILENAME_PARSING_IMPROVEMENTS.md` - 之前的文件名解析改进
- `src/main/manual_equity_editor.py` - 实现代码

---

**总结**: 现在系统能自动识别文件名中的公司名和关系类型，无论它们的顺序如何！🎉

