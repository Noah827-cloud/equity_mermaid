# 股权分析平台用户指导手册

本手册面向业务与数据分析人员，帮助你快速了解并高效使用 **Equity Mermaid** 股权分析平台的全部现有功能。平台基于 Streamlit 提供图形化界面，既支持 AI 图像识别自动生成股权结构，也支持精细化的手动编辑、校验与导出。

---

## 1. 平台概览

- **主控台（main_page.py，端口 8504）**：提供产品介绍、功能导航、常见场景说明与快速入口。
- **图像识别模式（pages/1_图像识别模式.py，端口 8501）**：上传股权结构图片，调用阿里云 DashScope（或内置示例数据）自动抽取实体、股权关系，并即时生成 Mermaid 与 HTML 图表。
- **手动编辑模式（pages/2_手动编辑模式.py，端口 8503）**：六步向导式编辑流程，覆盖核心公司、股东、子公司、合并、关系设置到最终图表生成；内置 AI 辅助分析、Excel 智能导入、自动保存与翻译能力。
- **工具组件**：
  - `src/utils/mermaid_function.py`：统一的 Mermaid 代码生成器，支持中英双语、多字段排版与安全导出。
  - `src/utils/visjs_equity_chart.py`：生成带缩放、主题、分组与 PNG 导出功能的交互式 HTML 图。
  - `src/utils/excel_smart_importer.py`：Excel 智能导入器，自动识别列含义、实体类型、金额/日期格式。
  - `src/utils/translator_service.py` & `src/utils/translation_usage.py`：阿里云翻译能力封装、额度控制与缓存。
  - `src/utils/state_persistence.py`：自动保存、工作区快照管理。

---

## 2. 环境准备

### 2.1 系统要求

- Python 3.10+（建议使用项目内同版本）
- 已安装 Git 以便拉取更新
- 需要主动访问互联网时请提前准备代理（可选）
- 阿里云 DashScope 与机器翻译 AccessKey（仅在启用 AI 或翻译时必需）

### 2.2 安装依赖

```bash
pip install -r requirements.txt
```

如需打包，可使用 `build_exe.bat`（Windows）或 `scripts/setup.sh`（Linux/Mac）按需调整。

### 2.3 配置文件

- `config.json`：可在 `alicloud_translator` 节点配置 `access_key_id` / `access_key_secret`。未配置时，系统读取环境变量 `ALICLOUD_ACCESS_KEY_ID` / `ALICLOUD_ACCESS_KEY_SECRET`。
- `.streamlit/config.toml`：定义全局主题颜色，与主界面样式保持一致。
- `user_data/`：运行时生成。包含自动保存、翻译缓存、使用统计等。

---

## 3. 启动与访问

### 3.1 快速启动

- **首选方式（一个实例即可）**  
  直接运行主页即可完成全部操作，Streamlit 默认监听 8501 端口：
  ```bash
  streamlit run main_page.py
  ```
  进入主页后，可通过左侧导航按钮跳转到「图像识别模式」和「手动编辑模式」，无需为每个页面单独启动服务。

- **多实例模式（可选）**  
  若需要分别占用固定端口（如并行演示或压测），可手动指定端口启动：
  - 主控台：`streamlit run main_page.py --server.port 8504`
  - 图像识别模式：`streamlit run src/main/enhanced_equity_to_mermaid.py --server.port 8501`
  - 手动编辑模式：`streamlit run src/main/manual_equity_editor.py --server.port 8503`

- **Windows 批处理**  
  运行 `scripts/start_all.bat` 会同时拉起三个实例，端口与上表一致。仅在确需多窗口并存时使用。

- **run_st.py**  
  该脚本用于守护式启动，内部将主控台绑定到 8501，并写入 `user_data/app_ready.flag` 供外部脚本检测服务状态。

### 3.2 访问入口

| 功能 | 端口 | 说明 |
| --- | --- | --- |
| 主控台（推荐入口） | `http://localhost:8501` | 默认启动端口，通过导航访问所有功能 |
| 主控台（start_all.bat / 指定端口） | `http://localhost:8504` | 运行批处理或手动指定端口时的绑定值 |
| 图像识别模式（独立启动或批处理） | `http://localhost:8501` | 单独调试图像识别时默认端口；若主页已占用，可改用其他端口 |
| 手动编辑模式（独立启动或批处理） | `http://localhost:8503` | 多实例或单独调试时的默认端口 |

在推荐的一体化启动方案中，只需访问 `http://localhost:8501`，再通过侧边栏按钮（🏠 主页 / 🔍 图像识别模式 / 📊 手动编辑模式）即可在不同功能间切换；仅当需要并行实例或独立调试时，再按需绑定其他端口。

---

## 4. 主控台（Main Page）

进入 `main_page.py` 后你将看到：

- **顶部导航条**：品牌标识、亮点卖点。
- **Hero 版块**：概述平台价值、核心能力介绍。
- **功能卡片**：分别展示图像识别、手动编辑、AI 辅助、数据导出等功能，带有图标与文案。
- **典型场景**：按「尽调报告」「投后监控」「融资披露」「内部培训」等业务场景列出操作建议。
- **操作指南**：侧边栏 `使用帮助` 展开面板详细列出每个模式的操作步骤、导入方式与导出内容。
- **页脚**：版权信息与 GitHub 链接。

主控台的所有按钮均指向 Streamlit 内的其他页面，无需刷新即可跳转。

---

## 5. 图像识别模式

### 5.1 工作流程

1. **上传图片**：支持 PNG / JPG / JPEG。上传后会显示预览。
2. **配置 API 与翻译**：
   - 勾选「使用阿里云通义千问API进行图片分析」可切换到真实识别，需填写 DashScope API Key。
   - 不勾选时使用内置模拟数据，方便演示与培训。
   - 可启用「将中文股权信息翻译成英文」，系统会检查 `config.json` 或环境变量中的阿里云翻译 AccessKey，并实时显示翻译额度（已用/剩余）。
3. **点击「🔍 开始分析」**：系统调用 `analyze_image_with_llm`。
   - 真正调用 DashScope 时会将图片编码为 base64 并附带提示词，要求模型严格输出 JSON。
   - 失败时自动回退到模拟数据并给出错误提示。
4. **结果处理**：
   - 统一通过 `generate_mermaid_from_data` 生成 Mermaid 代码，避免字段缺失导致绘图失败。
   - 如启用了翻译，所有实体名称会在生成过程中调用 `translate_equity_data`，额满时显示警告并继续使用原文。
5. **可视化与导出**：
   - 页面内嵌 Mermaid 图表。
   - 「🔍 全屏查看 (带编辑器)」会在浏览器新标签打开增强型编辑器：支持代码/图谱对照、拖拽分栏、Ctrl+滚轮缩放、全屏模式、导出 PNG。
   - 「📥 下载Mermaid代码」支持直接保存 `.mmd` 文件。
   - 页面下方按层级列出实际控制人、主要股东、子公司，并提供 JSON 原始数据(`📄 查看JSON数据`)。

### 5.2 实用提示

- 支持「🧪 加载测试数据」，便于培训或模拟。
- 图像识别输出会尽量保留 API 原字段，如无 `entity_relationships`，仍会根据 `shareholders` 自动补关系以保证图表完整。
- 页面会打印 Debug/JSON 信息（在调试模式下展开），便于排查识别异常。

---

## 6. 手动编辑模式（六步向导）

手动编辑模式通过顶部步骤条和进度条引导完成数据录入。导航按钮支持回退/前进/重置，系统会在离开当前步骤前检查是否有未保存修改。

### 6.1 全局能力

- **自动保存与工作区**：当进入「关系设置」步骤后，右上角会显示「💾 保存/恢复进度」。系统自动根据核心公司名生成工作区文件夹（`user_data/autosave/<workspace>`），保留最近 10 份快照，可一键恢复或下载。
- **翻译与英文名格式化**：侧边栏提供「翻译额度管理」与「📝 批量格式化英文名称」。管理员可输入密码（默认 `Noah2025@Ali` 或配置自定义）调整本月额度。
- **调试模式**：侧边栏复选框「显示调试信息」开启后，会展示实体统计、自动导入记录、工作区命名、合并/过滤调试等细节。
- **数据验证**：每个关键操作前后调用 `validate_equity_data`，确保核心公司、实体列表、关系结构合法。

### 6.2 第 1 步：核心公司

- 表单字段：核心公司名称、实际控制人、英文名称、注册资本、成立日期。
- 「保存并继续」自动：
  - 同步 `workspace_name`（除非用户手动指定）。
  - 更新 `all_entities` 中的核心公司记录，并将可选字段传播至所有列表。
  - 当名称变更时，批量修正所有股权/控制关系的 `parent` / `child` / `from` / `to`。
- 「加载示例数据」提供一套完整样例并跳转到关系设置。
- **AI 辅助**：
  - 「🤖 AI分析功能」支持上传多个 Excel（通过「➕ 上传股权结构文件」弹出对话框）或仅输入提示文本，再调用 `analyze_equity_with_ai`。
  - 分析结果会自动填充核心公司、实际控制人、顶级实体、子公司与关系，并显示完整的日志、数据完整性检测以及（可选）分析报告下载。

### 6.3 第 2 步：顶级实体 / 股东

- **编辑现有股东**：点击列表项下的「编辑」进入表单，可修改名称、持股比例、实体类型、英文名、注册资本、成立日期，系统会同步更新 `all_entities` 及相关关系。
- **新增股东**：
  - 「➕ 添加新的顶级实体/股东」表单支持自动从名称中提取括号内比例，支持英文名、金额、成立日期。
  - 自动判断实体类型（公司/个人），并可一键创建股权关系（文件导入时亦会自动补充）。
- **Excel 智能导入**：
  - 单表导入：上传后展示列预览、自动匹配列（名称、比例、英文名、认缴/注册资本、成立日期、登记状态），可手动修正映射。
  - 批量导入：支持多文件、自动识别文件类型（股东 vs 对外投资），依据文件名后缀调整导向（股东→公司 或 公司→子公司）。
  - 导入后统计总文件数、成功文件数、导入实体数、创建关系数，并列出失败原因。
  - 内建规则：剔除登记状态为注销/吊销、空值或重复记录；保留原文件名和智能推断的实体类型。

### 6.4 第 3 步：子公司

- 列表展示所有子公司，支持逐个展开编辑或删除。删除时会同步清理关联的股权/控制关系及合并实体。
- 「📊 从Excel导入子公司」与股东导入流程一致，但默认把文件名视为母公司，自动创建关系、支持注册资本/认缴额/成立日期、登记状态识别。
- 导入说明强调文件命名规则（`公司A-对外投资.xlsx` 等）以便自动反转关系方向。

### 6.5 第 4 步：股权合并

- 支持两种模式：
  1. **按阈值合并**：设定一个比例阈值（如 1%），自动收集低于阈值的股东/子公司，汇总为自定义名称（默认“其他股东/其他子公司”）。
  2. **手动合并**：勾选多个实体，自定义合并后的名称与总比例。
- 合并结果记录在 `merged_entities`，原实体被标记为隐藏，可随时查看、撤销。
- 实时更新 `hidden_entities` 列表，与后续关系过滤、图表生成保持一致。

### 6.6 第 5 步：关系设置

- 页面分为两个 Tab：
  - **🔗 添加股权关系**：选择母公司/股东与子公司，系统根据顶级实体默认填充比例，可手动覆盖。支持实时预览（勾选复选框后开启），自动去除已隐藏实体并处理合并节点。
  - **⚡ 添加控制关系**：用于补充实际控制人或穿透控制链，默认描述为“实际控制”，支持自定义。
- **实时预览**：
  - 「🔍 实时预览」板块调用 `generate_mermaid_from_data` 生成即时图表，可展开查看传递给 Mermaid 的数据与调试信息。
  - 支持按比例阈值批量隐藏关系、管理隐藏列表，并提供过滤调试结果。
- **关系维护**：支持编辑、删除、批量删除；删除时会同步处理合并实体与过滤列表。
- **AI 分析报告**：
  - 「执行股权结构分析」调用 `analyze_equity_with_llm` 对当前数据生成要点摘要或完整报告，支持查看/下载 TXT。
  - 当关系不足时提示补充数据后再运行。

### 6.7 第 6 步：生成图表

- 「📊 生成股权结构图」页面展示最终数据结构，可展开查看 JSON。
- 操作区：
  - 「返回编辑」：需通过验证才允许回退。
  - 「翻译所有实体」：在导出前批量补齐英文名（调用翻译服务并缓存）。
  - 「生成图表」：生成 Mermaid 代码并缓存到 `st.session_state.mermaid_code`。
- 生成后提供两种输出：
  1. **Mermaid 图表**：页面内渲染，支持下载 `.mmd` 与 `.json`。
  2. **交互式 HTML 图**：点击「🔍 全屏查看 (带编辑器)」后调用 `generate_visjs_html` / `generate_fullscreen_visjs_html`，在新窗口展示 vis.js 图谱，包含主题切换、缩放、分层、节点高亮、导出 PNG。
- 所有导出均保证只包含有效实体与关系（会自动过滤被隐藏或未建立关系的节点）。

---

## 7. 数据导入与 AI 辅助

| 功能 | 入口 | 说明 |
| --- | --- | --- |
| AI 文件分析 | 步骤 1 的「🤖 AI分析功能」 | 支持上传多个 Excel/CSV/PDF（经测试 Excel 为最佳），可同时输入分析提示；自动填充核心公司、股东、子公司、关系。 |
| 股东导入 | 步骤 2 | 单文件或批量上传，智能识别列，自动区分股东 vs 投资文件，生成股权关系。 |
| 子公司导入 | 步骤 3 | 类似股东导入，额外指导文件命名来决定关系方向。 |
| 模型提示词 | `enhanced_equity_to_mermaid.py` | 调用 DashScope 时强制模型只返回 JSON，并给出详细字段说明，确保识别准确。 |

导入/分析完成后，列表会展示成功/失败详情，便于人工复核；所有自动创建的关系均可在后续步骤中编辑或删除。

---

## 8. 翻译与额度管理

- **启用位置**：
  - 图像识别模式的「将中文股权信息翻译成英文」复选框。
  - 手动编辑模式步骤 6 的「翻译所有实体」按钮。
- **额度控制**：
  - `translation_usage.json` 记录每月用量（默认额度 50,000 字符），调用翻译前会检查余额，不足时抛出 `QuotaExceededError` 并提示。
  - 侧边栏「翻译额度管理」支持管理员调节月度额度、查看剩余额度。
- **缓存与格式化**：
  - 翻译结果按照原文 + 语言对缓存，避免重复计费。
  - 目标语言为英文时自动调用 `format_english_company_name` 规范大小写。
  - 手动填写英文名称会主动写入缓存，优先生效。

---

## 9. 自动保存与工作区

- 系统默认在 `user_data/autosave/<workspace>` 下保存最近 10 份快照，命名规则 `workspace-YYYYMMDD-HHMMSS.json`。
- 工作区名称来源：
  1. 用户手动输入的自定义名称（优先）。
  2. 核心公司名称。
  3. 自动生成的 `workspace-时间戳`。
- 「💾 保存/恢复进度」提供：
  - 当前快照强制保存开关。
  - 自动保存历史列表（含保存时间、文件大小）。
  - 一键恢复（调用 `apply_snapshot`）与下载。
  - 调试模式下还会显示命名、过滤等额外信息。

---

## 10. 图表导出与共享

- **Mermaid 导出**：
  - 图像识别与手动编辑两种模式都可导出 `.mmd`。
  - `generate_mermaid_html_with_security` 提供安全级别为 `antiscript` 的 HTML 模版。
  - Mermaid 标签自动插入英文名、注册资本（格式如 `Cap: RMB 50M`）、成立日期、换行与控制关系说明。
- **交互式 HTML（vis.js）**：
  - 支持主题切换（蓝/红/绿/紫/橙/灰）、拖拽、缩放、展开收起、节点搜索。
  - 工具栏内置「保存 PNG」「重排布局」「锁定层级」等操作。
  - 节点标签自动格式化中英文、金额、日期；小比例股东会自动调整颜色和字号以增强可读性。
- **PNG 导出**：
  - HTML 编辑器内置 `下载PNG`，直接得到高分辨率图。

---

## 11. 常用脚本与运维建议

- `scripts/start_all.bat`：Windows 同时启动三个服务。
- `scripts/run_app.py`：封装启动逻辑，便于在批处理或服务管理器中调用。
- `scripts/fix_expander.py`、`fix_protobuf_issue.py`：针对常见依赖/布局问题的修复脚本，可在遇到相关报错时执行。
- `equity_mermaid.spec`：PyInstaller 打包配置，配合 `build_exe.bat` 生成离线可执行文件。
- `user_data/app_ready.flag`：`run_st.py` 启动后写入，第三方脚本可轮询该文件判断服务是否就绪。
- 建议将 `user_data/` 目录纳入备份策略，包含翻译额度、缓存、自动保存等关键数据。

---

## 12. 操作最佳实践

1. **先导入再细化**：优先使用 AI 分析或 Excel 导入快速搭建初稿，再进入手动步骤补充细节、调整合并与关系。
2. **善用实时预览**：在步骤 5 勾选实时预览，边设置关系边校对图表，减少反复生成的成本。
3. **翻译额度前置检查**：启用翻译前确认额度充足，避免导出阶段才发现英文名缺失。
4. **命名规则统一**：确保 Excel 文件名包含股东/对外投资等关键词，列标题尽量贴近中文原意，以便智能识别。
5. **及时保存**：虽然系统有自动保存，仍建议在关键操作后进入保存面板查看历史记录，必要时手动下载快照。

---

## 13. 常见问题

| 问题 | 处理建议 |
| --- | --- |
| DashScope 调用失败 | 检查 API Key、网络连通，必要时先使用模拟数据；错误详情会在界面提示。 |
| 翻译额度耗尽 | 侧边栏输入管理员密码调整额度或等待下月自动重置。 |
| Excel 导入字段匹配不准确 | 在列映射页面手动选择正确列；导入前可清理多余表头或合并单元格。 |
| 图表缺少某些关系列 | 确认实体是否被隐藏 / 合并；步骤 5 的隐藏列表可恢复。 |
| Mermaid 图乱码 | 生成前可使用「翻译所有实体」或手动填写英文名，确保标签内无特殊字符。 |

---

如需进一步扩展或二次开发，可参考 `docs/DEPLOYMENT_GUIDE.md` 与 `CHANGELOG_*.md` 获取部署说明与迭代记录。祝使用顺利！
